
@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>


<div class="jumbotron">
    <div class="d-flex mr-2">
        <select class="form-select" id="drzavaSelect"style="margin-bottom:20px" aria-label="Default select example">
        </select>
        <select class="form-select" id="gradSelect" style="margin-bottom:20px" aria-label="Default select example">
        </select>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ime</th>
                <th>Prezime</th>
                <th>E-mail</th>
                <th></th>
            </tr>
        </thead>
    </table>
</div>

@section scripts {
    <script>

        let drzavaId = 1;

        GetDrzave();
        GetGradoviByDrzava(drzavaId);
        
        $('#drzavaSelect').on('change', function () {
            drzavaId = this.value;
            GetGradoviByDrzava(drzavaId);
        });

        function GetGradoviByDrzava(drzavaId) {
            $.ajax({
                url: '/api/gradovi/' + drzavaId,
                type: 'GET',
                dataType: 'json',
                success: function (res) {
                    $('#gradSelect').children().remove().end();
                    $.each(res, function (i, value) {
                        $('#gradSelect').append($('<option>').text(value.Naziv).attr('value', value.Naziv));
                    });
                }
            });
        }

        function GetDrzave() {
            $.ajax({
                url: '/api/drzava',
                type: 'GET',
                dataType: 'json',
                success: function (res) {
                    $.each(res, function (i, value) {
                        $('#drzavaSelect').append($('<option>').text(value.Naziv).attr('value', value.IDDrzava));
                    });
                }
            });
        }

        //$.ajax({
        //    url: '/api/gradovi',
        //    type: 'GET',
        //    dataType: 'json',
        //    data: drzavaId,
        //    success: function (res) {
        //        $.each(res, function (i, value) {
        //            $('#gradSelect').append($('<option>').text(value.Naziv).attr('value', value.Naziv));
        //        });
        //    }
        //});

        

        const dataTableConfig = {
            ajax: {
                url: '/api/kupci',
                dataSrc:''
            },
            columns: [
                { data: 'IDKupac'},
                { data: 'Ime'},
                { data: 'Prezime'},
                {
                    data: 'Email',
                    render: function (email) {
                        return `<a href="mailto:${email}">${email}</a>`
                    }
                },
                {
                    data: '',
                    render: function (data, type, kupac) {
                        return `<button
                                    class="btn btn-danger btn-sm"
                                    data-id=${kupac.IDKupac}
                                    data-ime=${kupac.Ime}
                                    data-prezime=${kupac.Prezime}>
                                    Delete
                                </button>`
                    }
                }
            ],
            lengthMenu: [[10, 25, 50], [10, 25, 50]],
            columnDefs: [
                { orderable: false, targets: [0,3,4] }
            ]
        }

        let btnDelete;

        const table = $('.table')
            .DataTable(dataTableConfig)
            .on('click', '.btn', onDeleteClick);

        function onDeleteClick(e) {
            btnDelete = this;
            const { id, ime, prezime } = btnDelete.dataset;

            if (confirm(`Obrisati ${ime} ${prezime}`))
                deleteKupac(id);
        }

        function deleteKupac(id) {
            $.ajax({
                url: `/api/kupci/${id}`,
                method: 'delete'
            })
                .done(function (message) {
                    console.log(message);
                    table
                        .row($(btnDelete).parents('tr'))
                        .remove()
                        .draw();
                })
                .fail(function () {
                    console.log('Kupac nije obrisan');
                });
        }

    </script>

}